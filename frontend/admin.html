<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard | NexCura</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #0056b3;
      --secondary-color: #00a8cc;
      --accent-color: #eef2f3;
      --text-color: #333;
      --white: #ffffff;
      --danger-color: #e74c3c;
      --success-color: #2ecc71;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e0f7fa 0%, #ffffff 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      color: var(--text-color);
    }

    /* Auth Styles */
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 90vh;
    }
    .box {
      width: 100%;
      max-width: 400px;
      background: var(--white);
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
      border-top: 5px solid var(--primary-color);
      text-align: center;
    }
    h2 { color: var(--primary-color); margin-bottom: 20px; }
    input, button {
      width: 100%;
      padding: 12px;
      margin-top: 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      box-sizing: border-box;
      font-size: 1rem;
    }
    button {
      background: var(--primary-color);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
      margin-top: 20px;
    }
    button:hover { background: #004494; }
    .toggle-link { margin-top: 15px; font-size: 0.9rem; }
    .toggle-link a { color: var(--secondary-color); text-decoration: none; font-weight: bold; }
    .back-link { display: block; text-align: center; margin-top: 20px; color: #7f8c8d; text-decoration: none; }

    /* Dashboard Styles */
    .dashboard-container { max-width: 1200px; margin: 0 auto; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .hospital-name { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); }
    .logout-btn { width: auto; margin: 0; background: var(--danger-color); cursor: pointer; }

    .metrics {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    .card {
      flex: 1;
      background: var(--white);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      text-align: center;
      min-width: 200px;
      border-left: 5px solid var(--secondary-color);
    }
    .card h3 { margin: 0 0 10px; color: #666; font-size: 1rem; }
    .card p { font-size: 2rem; font-weight: bold; color: var(--primary-color); margin: 0; }

    table { width: 100%; background: var(--white); border-collapse: collapse; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: var(--primary-color); color: white; font-weight: 600; }
    tr:last-child td { border-bottom: none; }
    .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
    .status-waiting { background: #fff3cd; color: #856404; }
    .status-consultation { background: #d4edda; color: #155724; }

    .hidden { display: none; }
    
    .btn-approve { background: var(--secondary-color); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
    .btn-approve:hover { background: #008cba; }
    .btn-new { background: var(--success-color); color: white; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: bold; width: auto; margin: 0; }
  </style>
</head>

<body>

<!-- AUTH SECTION -->
<div id="authContainer" class="auth-container">
  <div class="box">
    <!-- Sign In -->
    <div id="signinSection">
      <h2><i class="fas fa-user-shield"></i> Admin Login</h2>
      <input type="email" placeholder="Admin Email" id="adminEmail">
      <input type="password" placeholder="Password" id="adminPassword">
      <button onclick="loginAdmin()">Login</button>
      <div class="toggle-link">
        New Admin? <a href="#" onclick="toggleAuth()">Register Here</a>
      </div>
    </div>

    <!-- Sign Up -->
    <div id="signupSection" class="hidden">
      <h2><i class="fas fa-user-plus"></i> Admin Registration</h2>
      <input type="text" placeholder="Full Name" id="regName">
      <input type="text" placeholder="Hospital ID" id="regId">
      <input type="email" placeholder="Email Address" id="regEmail">
      <input type="password" placeholder="Password" id="regPassword">
      <button onclick="registerAdmin()">Register</button>
      <div class="toggle-link">
        Already registered? <a href="#" onclick="toggleAuth()">Login Here</a>
      </div>
    </div>
    
    <a href="index.html" class="back-link">Back to Home</a>
  </div>
</div>

<!-- DASHBOARD SECTION -->
<div id="dashboardContainer" class="dashboard-container hidden">
  <header>
    <div class="hospital-name"><i class="fas fa-hospital"></i> NexCura Admin</div>
    <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
  </header>

  <div class="metrics">
    <div class="card">
      <h3><i class="fas fa-users"></i> Total Waiting</h3>
      <p>18</p>
    </div>
    <div class="card">
      <h3><i class="fas fa-clock"></i> Avg Wait Time</h3>
      <p>20 min</p>
    </div>
    <div class="card" style="border-color: var(--danger-color);">
      <h3><i class="fas fa-ambulance"></i> Emergency</h3>
      <p style="color: var(--danger-color);">3</p>
    </div>
    <div class="card" style="border-color: var(--success-color);">
      <h3><i class="fas fa-user-md"></i> Doctors Active</h3>
      <p style="color: var(--success-color);">8</p>
    </div>
  </div>

  <!-- Pending Requests -->
  <h3><i class="fas fa-inbox"></i> Incoming Patient Requests</h3>
  <table id="pendingTable" style="margin-bottom: 40px;">
    <thead>
      <tr>
        <th>Patient Name</th>
        <th>Age / Gender</th>
        <th>Department</th>
        <th>Symptoms</th>
        <th>Priority</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rows will be added dynamically -->
    </tbody>
  </table>

  <!-- Live Queue -->
  <h3><i class="fas fa-list-ol"></i> Live Patient Queue</h3>
  <table id="queueTable">
    <thead>
      <tr>
        <th>Token</th>
        <th>Patient Name</th>
        <th>Department</th>
        <th>Doctor</th>
        <th>Est. Time</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rows will be added dynamically -->
    </tbody>
  </table>
</div>

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, query, where, onSnapshot, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // Your web app's Firebase configuration
  // REPLACE with your actual config from Firebase Console
  const firebaseConfig = {
    apiKey: "AIzaSyC8IiQsmrU2Gy1SOzfFdQf41c-M-R5prLQ",
    authDomain: "nexcura-32ea9.firebaseapp.com",
    projectId: "nexcura-32ea9",
    storageBucket: "nexcura-32ea9.firebasestorage.app",
    messagingSenderId: "12282098251",
    appId: "1:12282098251:web:b26e8879d8822c488ad3ce"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // --- Global Functions for HTML ---
  window.toggleAuth = function() {
    document.getElementById("signinSection").classList.toggle("hidden");
    document.getElementById("signupSection").classList.toggle("hidden");
  }

  window.loginAdmin = async function() {
    const email = document.getElementById('adminEmail').value.trim();
    const password = document.getElementById('adminPassword').value;

    if (!email || !password) {
      alert("Please enter both email and password.");
      return;
    }

    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
      console.error("Login Error:", error);
      if (error.code === 'auth/invalid-credential') {
        alert("Login Failed: Invalid Email or Password. If you haven't registered, please click 'Register Here'.");
      } else if (error.code === 'auth/user-not-found') {
        alert("Login Failed: Account not found. Please click 'Register Here'.");
      } else if (error.code === 'auth/invalid-email') {
        alert("Login Failed: Invalid Email Format.");
      } else {
        alert("Login Failed: " + error.message);
      }
    }
  }

  window.registerAdmin = async function() {
    const email = document.getElementById('regEmail').value.trim();
    const password = document.getElementById('regPassword').value;

    if (!email || !password) {
      alert("Please enter both email and password.");
      return;
    }

    try {
      await createUserWithEmailAndPassword(auth, email, password);
      alert("Admin Registered! Logging in...");
    } catch (error) {
      alert("Registration Failed: " + error.message);
    }
  }

  window.logout = function() {
    signOut(auth).then(() => location.reload());
  }

  // Auth State Listener
  onAuthStateChanged(auth, (user) => {
    if (user) {
      document.getElementById("authContainer").classList.add("hidden");
      document.getElementById("dashboardContainer").classList.remove("hidden");
      document.body.style.padding = "40px";
      console.log("Admin Logged In. Loading Dashboard...");
      startListeners();
      
      // Update logout button to use real logout
      document.querySelector('.logout-btn').onclick = window.logout;
    }
  });

  window.approveRequest = async function(docId) {
    // Generate Token & Assign Doctor
    const token = "T-" + Math.floor(Math.random() * 1000);
    const doctors = ["Dr. Smith", "Dr. Jones", "Dr. Emily"];
    const doctor = doctors[Math.floor(Math.random() * doctors.length)];
    const time = (Math.floor(Math.random() * 40) + 10) + " min";

    try {
      await updateDoc(doc(db, "appointments", docId), {
        status: "waiting",
        token: token,
        doctor: doctor,
        estimatedTime: time
      });
    } catch(e) {
      console.error("Error approving:", e);
    }
  }

  // --- Real-time Listeners ---
  function startListeners() {
    // 1. Listen for Pending Requests
    try {
      const qPending = query(collection(db, "appointments"), where("status", "==", "pending"));
      onSnapshot(qPending, (snapshot) => {
        const tbody = document.getElementById('pendingTable').getElementsByTagName('tbody')[0];
        tbody.innerHTML = ""; // Clear table
        snapshot.forEach((doc) => {
          const data = doc.data();
          const row = tbody.insertRow();
          row.innerHTML = `
            <td>${data.patientName}</td>
            <td>${data.age} / ${data.gender}</td>
            <td>${data.department}</td>
            <td>${data.symptoms}</td>
            <td>${data.priority}</td>
            <td><button class="btn-approve" onclick="approveRequest('${doc.id}')">Approve</button></td>
          `;
        });
      }, (error) => console.error("Error fetching pending requests:", error));
    } catch (e) { console.error("Setup Error:", e); }

    // 2. Listen for Live Queue (Waiting)
    try {
      const qWaiting = query(collection(db, "appointments"), where("status", "==", "waiting"));
      onSnapshot(qWaiting, (snapshot) => {
        const tbody = document.getElementById('queueTable').getElementsByTagName('tbody')[0];
        tbody.innerHTML = ""; // Clear table
        snapshot.forEach((doc) => {
          const data = doc.data();
          const row = tbody.insertRow();
          row.innerHTML = `
            <td><b>${data.token}</b></td>
            <td>${data.patientName}</td>
            <td>${data.department}</td>
            <td>${data.doctor}</td>
            <td>${data.estimatedTime}</td>
            <td><span class="status-badge status-waiting">Waiting</span></td>
            <td><button style="margin:0; padding:5px 10px; font-size:0.8rem; background:#7f8c8d; color:white; border:none; border-radius:4px;">Done</button></td>
          `;
        });
      }, (error) => console.error("Error fetching queue:", error));
    } catch (e) { console.error("Setup Error:", e); }
  }
</script>

</body>
</html>